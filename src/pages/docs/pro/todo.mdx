import { CodeComponent } from '@/components/code.component'
import DocsLayout from '@/layouts/docs.layout'
import ComponentLayout from '@/layouts/component.layout'
import { Button, FIBin, FIX, Icon, MenuProvider, Portal, Text, View, useDialog } from '@fold-dev/core'
import React, { useState } from 'react'
import { Detail, LabelMenu, Popup, Todo, TodoSectionMenu, UserMenu, dispatchTodoEvent, todoState } from '@fold-pro/react'
import * as data from '@/dummy-data'

export const docs = {"title":"Todo List","subtitle":"Organize your life like a boss with the Todo List component.","description":"The Todo List component is a powerful, but extremely flexible addition to any project or task management solution. Included is a rich-input experience.","pro":true}

export const props = [{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"TodoAddSection","methods":[],"props":{"onAdd":{"defaultValue":null,"description":"","name":"onAdd","declarations":[{"fileName":"pro/src/todo/todo-add-section.tsx","name":"TypeLiteral"}],"required":true,"type":{"name":"(value: string) => void"},"tags":{}},"onDismiss":{"defaultValue":null,"description":"","name":"onDismiss","declarations":[{"fileName":"pro/src/todo/todo-add-section.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"() => void"},"tags":{}}}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"TodoAddTask","methods":[],"props":{"onAdd":{"defaultValue":null,"description":"","name":"onAdd","declarations":[{"fileName":"pro/src/todo/todo-add-task.tsx","name":"TypeLiteral"}],"required":true,"type":{"name":"(value: string) => void"},"tags":{}}}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"TodoSectionHeader","methods":[],"props":{"id":{"defaultValue":null,"description":"","name":"id","declarations":[{"fileName":"pro/src/todo/todo-section-header.tsx","name":"TypeLiteral"}],"required":true,"type":{"name":"string"},"tags":{}},"name":{"defaultValue":null,"description":"","name":"name","declarations":[{"fileName":"pro/src/todo/todo-section-header.tsx","name":"TypeLiteral"}],"required":true,"type":{"name":"string"},"tags":{}},"description":{"defaultValue":null,"description":"","name":"description","declarations":[{"fileName":"pro/src/todo/todo-section-header.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"string"},"tags":{}},"color":{"defaultValue":null,"description":"","name":"color","declarations":[{"fileName":"pro/src/todo/todo-section-header.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"string"},"tags":{}},"prefix":{"defaultValue":null,"description":"","name":"prefix","declarations":[{"fileName":"pro/src/todo/todo-section-header.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"ReactElement<any, string | JSXElementConstructor<any>>"},"tags":{}},"tasks":{"defaultValue":null,"description":"","name":"tasks","declarations":[{"fileName":"pro/src/todo/todo-section-header.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"number"},"tags":{}},"collapsed":{"defaultValue":null,"description":"","name":"collapsed","declarations":[{"fileName":"pro/src/todo/todo-section-header.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"boolean"},"tags":{}},"collapsible":{"defaultValue":null,"description":"","name":"collapsible","declarations":[{"fileName":"pro/src/todo/todo-section-header.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"boolean"},"tags":{}},"editableName":{"defaultValue":null,"description":"","name":"editableName","declarations":[{"fileName":"pro/src/todo/todo-section-header.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"boolean"},"tags":{}},"taskCount":{"defaultValue":null,"description":"","name":"taskCount","declarations":[{"fileName":"pro/src/todo/todo-section-header.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"boolean"},"tags":{}}}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"TodoSectionMenu","methods":[],"props":{}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"TodoSection","methods":[],"props":{"index":{"defaultValue":null,"description":"","name":"index","declarations":[{"fileName":"pro/src/todo/todo-section.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"number"},"tags":{}}}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"TodoSections","methods":[],"props":{"sections":{"defaultValue":null,"description":"","name":"sections","declarations":[{"fileName":"pro/src/todo/todo-sections.tsx","name":"TypeLiteral"}],"required":true,"type":{"name":"Section[]"},"tags":{}}}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"TodoTaskEditor","methods":[],"props":{"isAddBelow":{"defaultValue":null,"description":"","name":"isAddBelow","declarations":[{"fileName":"pro/src/todo/todo-task-editor.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"boolean"},"tags":{}},"indented":{"defaultValue":null,"description":"","name":"indented","declarations":[{"fileName":"pro/src/todo/todo-task-editor.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"boolean"},"tags":{}},"autoFocus":{"defaultValue":null,"description":"","name":"autoFocus","declarations":[{"fileName":"pro/src/todo/todo-task-editor.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"boolean"},"tags":{}},"task":{"defaultValue":null,"description":"","name":"task","declarations":[{"fileName":"pro/src/todo/todo-task-editor.tsx","name":"TypeLiteral"}],"required":true,"type":{"name":"Task"},"tags":{}},"onSave":{"defaultValue":null,"description":"","name":"onSave","declarations":[{"fileName":"pro/src/todo/todo-task-editor.tsx","name":"TypeLiteral"}],"required":true,"type":{"name":"(value: any) => void"},"tags":{}},"onDismiss":{"defaultValue":null,"description":"","name":"onDismiss","declarations":[{"fileName":"pro/src/todo/todo-task-editor.tsx","name":"TypeLiteral"}],"required":true,"type":{"name":"() => void"},"tags":{}},"onIndent":{"defaultValue":null,"description":"","name":"onIndent","declarations":[{"fileName":"pro/src/todo/todo-task-editor.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"() => void"},"tags":{}},"onOutdent":{"defaultValue":null,"description":"","name":"onOutdent","declarations":[{"fileName":"pro/src/todo/todo-task-editor.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"() => void"},"tags":{}},"onAddBelowClose":{"defaultValue":null,"description":"","name":"onAddBelowClose","declarations":[{"fileName":"pro/src/todo/todo-task-editor.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"() => void"},"tags":{}}}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"TodoTaskItem","methods":[],"props":{}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"TodoTask","methods":[],"props":{"task":{"defaultValue":null,"description":"","name":"task","declarations":[{"fileName":"pro/src/todo/todo-task.tsx","name":"TypeLiteral"}],"required":true,"type":{"name":"Task"},"tags":{}},"visible":{"defaultValue":null,"description":"","name":"visible","declarations":[{"fileName":"pro/src/todo/todo-task.tsx","name":"TypeLiteral"}],"required":true,"type":{"name":"boolean"},"tags":{}},"indent":{"defaultValue":null,"description":"","name":"indent","declarations":[{"fileName":"pro/src/todo/todo-task.tsx","name":"TypeLiteral"}],"required":true,"type":{"name":"number"},"tags":{}},"parentSelected":{"defaultValue":null,"description":"","name":"parentSelected","declarations":[{"fileName":"pro/src/todo/todo-task.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"boolean"},"tags":{}}}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"TodoTasks","methods":[],"props":{"parentColor":{"defaultValue":null,"description":"","name":"parentColor","declarations":[{"fileName":"pro/src/todo/todo-tasks.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"string"},"tags":{}},"tasks":{"defaultValue":null,"description":"","name":"tasks","declarations":[{"fileName":"pro/src/todo/todo-tasks.tsx","name":"TypeLiteral"}],"required":true,"type":{"name":"Task[]"},"tags":{}},"visible":{"defaultValue":null,"description":"","name":"visible","declarations":[{"fileName":"pro/src/todo/todo-tasks.tsx","name":"TypeLiteral"}],"required":true,"type":{"name":"boolean"},"tags":{}},"indent":{"defaultValue":null,"description":"","name":"indent","declarations":[{"fileName":"pro/src/todo/todo-tasks.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"number"},"tags":{}},"parentSelected":{"defaultValue":null,"description":"","name":"parentSelected","declarations":[{"fileName":"pro/src/todo/todo-tasks.tsx","name":"TypeLiteral"}],"required":false,"type":{"name":"boolean"},"tags":{}}}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"TodoComponent","methods":[],"props":{}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"Todo","methods":[],"props":{}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"TodoProvider","methods":[],"props":{}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"getSectionIndex","methods":[],"props":{}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"flattenArrayWithLevel","methods":[],"props":{}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"nestObjectsByLevel","methods":[],"props":{}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"findSubtaskAmount","methods":[],"props":{}},{"tags":{},"filePath":"src/todo/index.ts","description":"","displayName":"todoState","methods":[],"props":{}}]

export const css = [[["--f-todo-padding","10px"],["--f-todo-background","var(--f-color-surface)"]],[["--f-todo-drag-opacity","0.9"]],[["--f-todo-section-header-color","var(--f-color-text-weak)"],["--f-todo-section-header-gap","14px"],["--f-todo-section-header-height","60px"],["--f-todo-section-description-color","var(--f-color-text-weaker)"],["--f-todo-section-header-font-size","16px"],["--f-todo-section-header-line-height","20px"],["--f-todo-section-header-description-font-size","12px"],["--f-todo-section-header-description-line-height","14px"],["--f-todo-section-header-pill-height","22px"],["--f-todo-section-header-pill-font-size","12px"],["--f-todo-section-header-pill-line-height","14px"],["--f-todo-section-header-collapse-width","30px"]],[["--f-todo-section-placeholder-background","var(--f-color-surface-stronger)"],["--f-todo-section-placeholder-radius","var(--f-radius)"],["--f-todo-section-placeholder-border","none"],["--f-todo-section-placeholder-outline","none"],["--f-todo-section-placeholder-margin","0"]],[["--f-todo-collapse-color","var(--f-color-text-weak)"],["--f-todo-collapse-left","0px"],["--f-todo-collapse-top","20px"],["--f-todo-collapse-icon-width","4px"],["--f-todo-collapse-icon-margin","0 0 0 20px"]],[["--f-todo-task-item-height","40px"],["--f-todo-task-item-padding","10px 0"],["--f-todo-task-item-height-footer","fit-content"],["--f-todo-task-item-select-color","var(--f-color-accent)"],["--f-todo-task-item-parent-select-color","var(--f-color-accent-weak)"],["--f-todo-task-item-select-width","2px"],["--f-todo-task-item-collapse-padding","0px"],["--f-todo-task-checkbox-width","20px"],["--f-todo-task-collapse-width","30px"]],[["--f-todo-task-footer-min-height","28px"],["--f-todo-task-footer-gap","4px"],["--f-todo-text-size","14px"],["--f-todo-text-size","14px"],["--f-todo-text-line-height","20px"],["--f-todo-text-color","var(--f-color-text)"],["--f-todo-text-color-complete","var(--f-color-text-weakest)"],["--f-todo-date-text-size","12px"],["--f-todo-date-line-height","14px"],["--f-todo-users-height","20px"]],[["--f-todo-add-section-padding","0px 34px"],["--f-todo-add-section-spacing","12px"],["--f-todo-add-section-height","40px"],["--f-todo-add-section-background","var(--f-color-surface)"]],[["--f-todo-add-task-background","var(--f-color-surface)"],["--f-todo-add-task-padding","10px 0px 10px 34px"],["--f-todo-add-task-spacing","10px"],["--f-todo-add-task-min-height","42px"],["--f-todo-add-task-text-size","12px"],["--f-todo-add-task-line-height","14px"]],[["--f-todo-task-editor-color","var(--f-color-text)"]],[["--f-todo-add-below-height","fit-content"],["--f-todo-add-below-padding","10px 0"]]]



<CodeComponent filename="todo.tsx" code="aW1wb3J0IHsKICBUb2RvQWRkU2VjdGlvbiwKICBUb2RvQWRkVGFzaywKICBUb2RvU2VjdGlvbkhlYWRlciwKICBUb2RvU2VjdGlvbk1lbnUsCiAgVG9kb1NlY3Rpb24sCiAgVG9kb1NlY3Rpb25zLAogIFRvZG9UYXNrRWRpdG9yLAogIFRvZG9UYXNrSXRlbSwKICBUb2RvVGFzaywKICBUb2RvVGFza3MsCiAgVG9kb0NvbXBvbmVudCwKICBUb2RvLAogIFRvZG9Qcm92aWRlciwKICBnZXRTZWN0aW9uSW5kZXgsCiAgZmxhdHRlbkFycmF5V2l0aExldmVsLAogIG5lc3RPYmplY3RzQnlMZXZlbCwKICBmaW5kU3VidGFza0Ftb3VudCwKICB0b2RvU3RhdGUsCn0gZnJvbSAiQGZvbGQtZGV2L2NvcmUiOwo=" />
```tsx
import {
  TodoAddSection,
  TodoAddTask,
  TodoSectionHeader,
  TodoSectionMenu,
  TodoSection,
  TodoSections,
  TodoTaskEditor,
  TodoTaskItem,
  TodoTask,
  TodoTasks,
  TodoComponent,
  Todo,
  TodoProvider,
  getSectionIndex,
  flattenArrayWithLevel,
  nestObjectsByLevel,
  findSubtaskAmount,
  todoState,
} from "@fold-dev/core";
```

### Usage

export const Usage = () => {
    const [sections, setSections] = useState(data.sections);
    const [task, setTask] = useState({});
    const [options, setOptions] = useState([]);
    const { setDialog, closeDialog } = useDialog();
    const handleTaskOpen = (task) => {
        todoState({ task, setTask, sections, setSections }).handleTaskOpen(task);
    };
    const handleTaskUpdate = (taskData) => {
        todoState({ task, setTask, sections, setSections }).handleTaskUpdate(taskData);
    };
    const handleTaskDelete = (task) => {
        setDialog({
            title: 'Are you sure?',
            description: 'This action cannot be undone.',
            footer: (<View row width="100%" justifyContent="space-between">
                    <Button onClick={closeDialog}>Cancel</Button>
                    <Button onClick={() => {
                    todoState({ task, setTask, sections, setSections }).handleTaskDelete(task);
                    closeDialog();
                }} variant="danger">
                        Delete
                    </Button>
                </View>),
        });
    };
    const handleTaskAddBelow = ({ id, shouldIndent, task: { title, users, badges, labels } }) => {
        todoState({ task, setTask, sections, setSections }).handleTaskAddBelow({
            id,
            shouldIndent,
            task: { title, users, badges, labels },
        });
    };
    const handleTaskAdd = ({ task, sectionIndex }) => {
        todoState({ task, setTask, sections, setSections }).handleTaskAdd({ task, sectionIndex });
    };
    const handleTaskMove = ({ origin, target, selection }) => {
        todoState({ task, setTask, sections, setSections }).handleTaskMove({ origin, target, selection });
    };
    const handleSectionUpdate = (sec) => {
        todoState({ task, setTask, sections, setSections }).handleSectionUpdate(sec);
    };
    const handleSectionDelete = (sec) => {
        todoState({ task, setTask, sections, setSections }).handleSectionDelete(sec);
    };
    const handleSectionAdd = ({ name, sectionIndex }) => {
        todoState({ task, setTask, sections, setSections }).handleSectionAdd({ name, sectionIndex });
    };
    const handleSectionMove = ({ origin, target }) => {
        todoState({ task, setTask, sections, setSections }).handleSectionMove({ origin, target });
    };
    const handleTrigger = (word) => {
        if (word.trim().charAt(0) == '@') {
            setOptions(data.richInputUsers);
        }
        else if (word.trim().charAt(0) == '#') {
            setOptions(data.richInputLabels);
        }
        else {
            setOptions([]);
        }
    };
    const handleHighlight = (word, cb, always = false) => {
        if (word.includes('date:')) {
            cb({
                phrase: word.trim(),
                type: 'date',
                value: word.split(':')[1].trim(),
            });
        }
        else {
            if (always)
                cb(null);
        }
    };
    const getMenu = ({ data: { target, payload }, dismiss }) => {
        switch (target) {
            case 'todo-label':
                return (<LabelMenu onFilter={(value) => console.log('filter', value)} availableLabels={data.availableLabels} labels={payload.labels} onCancel={dismiss} onSave={(labels) => {
                        handleTaskUpdate({ ...payload, labels });
                        dismiss();
                    }}/>);
            case 'todo-user':
                return (<UserMenu onFilter={(value) => console.log('filter', value)} availableUsers={data.availableUsers} users={payload.users} onCancel={dismiss} onSave={(users) => {
                        handleTaskUpdate({ ...payload, users });
                        dismiss();
                    }}/>);
            case 'todo-menu':
                return (<Popup isTodo item={payload} onCancel={dismiss} colorPalette={data.colorPalette} onTodoAddBelow={() => {
                        dismiss();
                        dispatchTodoEvent('add-task-below', { id: payload.id });
                    }} onTodoEdit={() => {
                        dismiss();
                        dispatchTodoEvent('edit-task', { id: payload.id });
                    }} onSave={(card) => {
                        dismiss();
                        handleTaskUpdate({ ...payload, ...card });
                    }} onView={() => {
                        dismiss();
                        setTask(payload);
                    }} onDelete={() => {
                        dismiss();
                        handleTaskDelete(payload);
                    }}/>);
            case 'todo-section':
                return (<TodoSectionMenu colorPalette={data.colorPalette} onSave={(section) => {
                        handleSectionUpdate({ ...payload, ...section });
                        dismiss();
                    }} onDelete={() => {
                        handleSectionDelete(payload);
                        dismiss();
                    }} section={payload}/>);
            default:
                return null;
        }
    };
    return (<>
            {!!task.id && (<Detail useRichTitle colorPalette={data.colorPalette} availableLabels={data.availableLabels} availableUsers={data.availableUsers} richInputHighlight={handleHighlight} richInputTrigger={handleTrigger} richInputOptions={options} item={{ ...task }} onCancel={() => {
                setTask({});
            }} onSave={(task) => {
                handleTaskUpdate(task);
                setTask({});
            }} onDelete={(task) => {
                handleTaskDelete(task);
                setTask({});
            }}/>)}

            <MenuProvider menu={getMenu}>
                <Todo id="todo-instance-1" sections={sections} onTaskOpen={handleTaskOpen} onTaskUpdate={handleTaskUpdate} onTaskAdd={handleTaskAdd} onTaskAddBelow={handleTaskAddBelow} onTaskMove={handleTaskMove} onSectionUpdate={handleSectionUpdate} onSectionAdd={handleSectionAdd} onSectionMove={handleSectionMove} availableLabels={data.availableLabels} onLabelFilter={(value) => console.log('filter labels', value)} availableUsers={data.availableUsers} onUserFilter={(value) => console.log('filter users', value)} richInputHighlight={handleHighlight} richInputTrigger={handleTrigger} richInputOptions={options} targetVariant={{ 'projects': 'focus' }} task={undefined} sectionHeader={undefined} defaultSelection={{}} toolbar={({ selection }) => {
            return (<View row position="fixed" bgToken="surface-inverse" colorToken="text-on-color" p="1rem 2rem" radius="var(--f-radius)" shadow="var(--f-shadow-xl)" zIndex={1000} gap={10} className="f-fadein" display={!Object.keys(selection).length ? 'none' : 'flex'} style={{ bottom: 10, left: '50%', transform: 'translateX(-50%)' }}>
                                <Text color="inherit">{Object.keys(selection).length} selected</Text>
                                <Icon icon={FIBin} className="f-buttonize" onClick={() => {
                    setDialog({
                        title: 'Are you sure?',
                        description: 'This action cannot be undone.',
                        portal: Portal,
                        footer: (<View width="100%" row justifyContent="space-between">
                                                    <Button onClick={() => {
                                closeDialog();
                                dispatchTodoEvent('select', {
                                    instanceId: 'todo-instance-1',
                                });
                            }}>
                                                        Cancel
                                                    </Button>
                                                    <Button variant="danger" onClick={() => {
                                todoState({
                                    task,
                                    setTask,
                                    sections,
                                    setSections,
                                }).handleSelectionDelete(selection);
                                dispatchTodoEvent('select', {
                                    instanceId: 'todo-instance-1',
                                });
                                closeDialog();
                            }}>
                                                        Delete
                                                    </Button>
                                                </View>),
                    });
                }}/>
                            </View>);
        }}/>
            </MenuProvider>
        </>);
};

<div className="story-block">
<Usage />
</div>

<CodeComponent filename="BasicUsage.tsx" code="ZXhwb3J0IGNvbnN0IFVzYWdlID0gKCkgPT4gewogICAgY29uc3QgW3NlY3Rpb25zLCBzZXRTZWN0aW9uc10gPSB1c2VTdGF0ZTxhbnk+KGRhdGEuc2VjdGlvbnMpCiAgICBjb25zdCBbdGFzaywgc2V0VGFza10gPSB1c2VTdGF0ZTxhbnk+KHt9KQogICAgY29uc3QgW29wdGlvbnMsIHNldE9wdGlvbnNdID0gdXNlU3RhdGU8YW55PihbXSkKICAgIGNvbnN0IHsgc2V0RGlhbG9nLCBjbG9zZURpYWxvZyB9ID0gdXNlRGlhbG9nKCkKCiAgICBjb25zdCBoYW5kbGVUYXNrT3BlbiA9ICh0YXNrKSA9PiB7CiAgICAgICAgdG9kb1N0YXRlKHsgdGFzaywgc2V0VGFzaywgc2VjdGlvbnMsIHNldFNlY3Rpb25zIH0pLmhhbmRsZVRhc2tPcGVuKHRhc2spCiAgICB9CgogICAgY29uc3QgaGFuZGxlVGFza1VwZGF0ZSA9ICh0YXNrRGF0YSkgPT4gewogICAgICAgIHRvZG9TdGF0ZSh7IHRhc2ssIHNldFRhc2ssIHNlY3Rpb25zLCBzZXRTZWN0aW9ucyB9KS5oYW5kbGVUYXNrVXBkYXRlKHRhc2tEYXRhKQogICAgfQoKICAgIGNvbnN0IGhhbmRsZVRhc2tEZWxldGUgPSAodGFzaykgPT4gewogICAgICAgIHNldERpYWxvZyh7CiAgICAgICAgICAgIHRpdGxlOiAnQXJlIHlvdSBzdXJlPycsCiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVGhpcyBhY3Rpb24gY2Fubm90IGJlIHVuZG9uZS4nLAogICAgICAgICAgICBmb290ZXI6ICgKICAgICAgICAgICAgICAgIDxWaWV3CiAgICAgICAgICAgICAgICAgICAgcm93CiAgICAgICAgICAgICAgICAgICAgd2lkdGg9IjEwMCUiCiAgICAgICAgICAgICAgICAgICAganVzdGlmeUNvbnRlbnQ9InNwYWNlLWJldHdlZW4iPgogICAgICAgICAgICAgICAgICAgIDxCdXR0b24gb25DbGljaz17Y2xvc2VEaWFsb2d9PkNhbmNlbDwvQnV0dG9uPgogICAgICAgICAgICAgICAgICAgIDxCdXR0b24KICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9kb1N0YXRlKHsgdGFzaywgc2V0VGFzaywgc2VjdGlvbnMsIHNldFNlY3Rpb25zIH0pLmhhbmRsZVRhc2tEZWxldGUodGFzaykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlRGlhbG9nKCkKICAgICAgICAgICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWFudD0iZGFuZ2VyIj4KICAgICAgICAgICAgICAgICAgICAgICAgRGVsZXRlCiAgICAgICAgICAgICAgICAgICAgPC9CdXR0b24+CiAgICAgICAgICAgICAgICA8L1ZpZXc+CiAgICAgICAgICAgICksCiAgICAgICAgfSkKICAgIH0KCiAgICBjb25zdCBoYW5kbGVUYXNrQWRkQmVsb3cgPSAoeyBpZCwgc2hvdWxkSW5kZW50LCB0YXNrOiB7IHRpdGxlLCB1c2VycywgYmFkZ2VzLCBsYWJlbHMgfSB9KSA9PiB7CiAgICAgICAgdG9kb1N0YXRlKHsgdGFzaywgc2V0VGFzaywgc2VjdGlvbnMsIHNldFNlY3Rpb25zIH0pLmhhbmRsZVRhc2tBZGRCZWxvdyh7CiAgICAgICAgICAgIGlkLAogICAgICAgICAgICBzaG91bGRJbmRlbnQsCiAgICAgICAgICAgIHRhc2s6IHsgdGl0bGUsIHVzZXJzLCBiYWRnZXMsIGxhYmVscyB9LAogICAgICAgIH0pCiAgICB9CgogICAgY29uc3QgaGFuZGxlVGFza0FkZCA9ICh7IHRhc2ssIHNlY3Rpb25JbmRleCB9KSA9PiB7CiAgICAgICAgdG9kb1N0YXRlKHsgdGFzaywgc2V0VGFzaywgc2VjdGlvbnMsIHNldFNlY3Rpb25zIH0pLmhhbmRsZVRhc2tBZGQoeyB0YXNrLCBzZWN0aW9uSW5kZXggfSkKICAgIH0KCiAgICBjb25zdCBoYW5kbGVUYXNrTW92ZSA9ICh7IG9yaWdpbiwgdGFyZ2V0LCBzZWxlY3Rpb24gfSkgPT4gewogICAgICAgIHRvZG9TdGF0ZSh7IHRhc2ssIHNldFRhc2ssIHNlY3Rpb25zLCBzZXRTZWN0aW9ucyB9KS5oYW5kbGVUYXNrTW92ZSh7IG9yaWdpbiwgdGFyZ2V0LCBzZWxlY3Rpb24gfSkKICAgIH0KCiAgICBjb25zdCBoYW5kbGVTZWN0aW9uVXBkYXRlID0gKHNlYykgPT4gewogICAgICAgIHRvZG9TdGF0ZSh7IHRhc2ssIHNldFRhc2ssIHNlY3Rpb25zLCBzZXRTZWN0aW9ucyB9KS5oYW5kbGVTZWN0aW9uVXBkYXRlKHNlYykKICAgIH0KCiAgICBjb25zdCBoYW5kbGVTZWN0aW9uRGVsZXRlID0gKHNlYykgPT4gewogICAgICAgIHRvZG9TdGF0ZSh7IHRhc2ssIHNldFRhc2ssIHNlY3Rpb25zLCBzZXRTZWN0aW9ucyB9KS5oYW5kbGVTZWN0aW9uRGVsZXRlKHNlYykKICAgIH0KCiAgICBjb25zdCBoYW5kbGVTZWN0aW9uQWRkID0gKHsgbmFtZSwgc2VjdGlvbkluZGV4IH0pID0+IHsKICAgICAgICB0b2RvU3RhdGUoeyB0YXNrLCBzZXRUYXNrLCBzZWN0aW9ucywgc2V0U2VjdGlvbnMgfSkuaGFuZGxlU2VjdGlvbkFkZCh7IG5hbWUsIHNlY3Rpb25JbmRleCB9KQogICAgfQoKICAgIGNvbnN0IGhhbmRsZVNlY3Rpb25Nb3ZlID0gKHsgb3JpZ2luLCB0YXJnZXQgfSkgPT4gewogICAgICAgIHRvZG9TdGF0ZSh7IHRhc2ssIHNldFRhc2ssIHNlY3Rpb25zLCBzZXRTZWN0aW9ucyB9KS5oYW5kbGVTZWN0aW9uTW92ZSh7IG9yaWdpbiwgdGFyZ2V0IH0pCiAgICB9CgogICAgY29uc3QgaGFuZGxlVHJpZ2dlciA9ICh3b3JkKSA9PiB7CiAgICAgICAgaWYgKHdvcmQudHJpbSgpLmNoYXJBdCgwKSA9PSAnQCcpIHsKICAgICAgICAgICAgc2V0T3B0aW9ucyhkYXRhLnJpY2hJbnB1dFVzZXJzKQogICAgICAgIH0gZWxzZSBpZiAod29yZC50cmltKCkuY2hhckF0KDApID09ICcjJykgewogICAgICAgICAgICBzZXRPcHRpb25zKGRhdGEucmljaElucHV0TGFiZWxzKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHNldE9wdGlvbnMoW10pCiAgICAgICAgfQogICAgfQoKICAgIGNvbnN0IGhhbmRsZUhpZ2hsaWdodCA9ICh3b3JkLCBjYiwgYWx3YXlzID0gZmFsc2UpID0+IHsKICAgICAgICBpZiAod29yZC5pbmNsdWRlcygnZGF0ZTonKSkgewogICAgICAgICAgICBjYih7CiAgICAgICAgICAgICAgICBwaHJhc2U6IHdvcmQudHJpbSgpLAogICAgICAgICAgICAgICAgdHlwZTogJ2RhdGUnLAogICAgICAgICAgICAgICAgdmFsdWU6IHdvcmQuc3BsaXQoJzonKVsxXS50cmltKCksCiAgICAgICAgICAgIH0pCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGFsd2F5cykgY2IobnVsbCkKICAgICAgICB9CiAgICB9CgogICAgY29uc3QgZ2V0TWVudSA9ICh7IGRhdGE6IHsgdGFyZ2V0LCBwYXlsb2FkIH0sIGRpc21pc3MgfSkgPT4gewogICAgICAgIHN3aXRjaCAodGFyZ2V0KSB7CiAgICAgICAgICAgIGNhc2UgJ3RvZG8tbGFiZWwnOgogICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICA8TGFiZWxNZW51CiAgICAgICAgICAgICAgICAgICAgICAgIG9uRmlsdGVyPXsodmFsdWUpID0+IGNvbnNvbGUubG9nKCdmaWx0ZXInLCB2YWx1ZSl9CiAgICAgICAgICAgICAgICAgICAgICAgIGF2YWlsYWJsZUxhYmVscz17ZGF0YS5hdmFpbGFibGVMYWJlbHN9CiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVscz17cGF5bG9hZC5sYWJlbHN9CiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2FuY2VsPXtkaXNtaXNzfQogICAgICAgICAgICAgICAgICAgICAgICBvblNhdmU9eyhsYWJlbHMpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZVRhc2tVcGRhdGUoeyAuLi5wYXlsb2FkLCBsYWJlbHMgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc21pc3MoKQogICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGNhc2UgJ3RvZG8tdXNlcic6CiAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgIDxVc2VyTWVudQogICAgICAgICAgICAgICAgICAgICAgICBvbkZpbHRlcj17KHZhbHVlKSA9PiBjb25zb2xlLmxvZygnZmlsdGVyJywgdmFsdWUpfQogICAgICAgICAgICAgICAgICAgICAgICBhdmFpbGFibGVVc2Vycz17ZGF0YS5hdmFpbGFibGVVc2Vyc30KICAgICAgICAgICAgICAgICAgICAgICAgdXNlcnM9e3BheWxvYWQudXNlcnN9CiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2FuY2VsPXtkaXNtaXNzfQogICAgICAgICAgICAgICAgICAgICAgICBvblNhdmU9eyh1c2VycykgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlVGFza1VwZGF0ZSh7IC4uLnBheWxvYWQsIHVzZXJzIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNtaXNzKCkKICAgICAgICAgICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICBjYXNlICd0b2RvLW1lbnUnOgogICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICA8UG9wdXAKICAgICAgICAgICAgICAgICAgICAgICAgaXNUb2RvCiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW09e3BheWxvYWR9CiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2FuY2VsPXtkaXNtaXNzfQogICAgICAgICAgICAgICAgICAgICAgICBjb2xvclBhbGV0dGU9e2RhdGEuY29sb3JQYWxldHRlfQogICAgICAgICAgICAgICAgICAgICAgICBvblRvZG9BZGRCZWxvdz17KCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzbWlzcygpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwYXRjaFRvZG9FdmVudCgnb3Blbi1hZGRiZWxvdycsIHsgaWQ6IHBheWxvYWQuaWQgfSkKICAgICAgICAgICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICAgICAgICAgICAgb25Ub2RvRWRpdD17KCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzbWlzcygpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwYXRjaFRvZG9FdmVudCgnZWRpdC10YXNrJywgeyBpZDogcGF5bG9hZC5pZCB9KQogICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgICAgICBvblNhdmU9eyhjYXJkKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNtaXNzKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZVRhc2tVcGRhdGUoeyAuLi5wYXlsb2FkLCAuLi5jYXJkIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIH19CiAgICAgICAgICAgICAgICAgICAgICAgIG9uVmlldz17KCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzbWlzcygpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUYXNrKHBheWxvYWQpCiAgICAgICAgICAgICAgICAgICAgICAgIH19CiAgICAgICAgICAgICAgICAgICAgICAgIG9uRGVsZXRlPXsoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNtaXNzKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZVRhc2tEZWxldGUocGF5bG9hZCkKICAgICAgICAgICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICAgICAgICAvPgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICBjYXNlICd0b2RvLXNlY3Rpb24nOgogICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICA8VG9kb1NlY3Rpb25NZW51CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yUGFsZXR0ZT17ZGF0YS5jb2xvclBhbGV0dGV9CiAgICAgICAgICAgICAgICAgICAgICAgIG9uU2F2ZT17KHNlY3Rpb24pID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZVNlY3Rpb25VcGRhdGUoeyAuLi5wYXlsb2FkLCAuLi5zZWN0aW9uIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNtaXNzKCkKICAgICAgICAgICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICAgICAgICAgICAgb25EZWxldGU9eygpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZVNlY3Rpb25EZWxldGUocGF5bG9hZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpc21pc3MoKQogICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgICAgICBzZWN0aW9uPXtwYXlsb2FkfQogICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbAogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gKAogICAgICAgIDw+CiAgICAgICAgICAgIHshIXRhc2suaWQgJiYgKAogICAgICAgICAgICAgICAgPERldGFpbAogICAgICAgICAgICAgICAgICAgIHVzZVJpY2hUaXRsZQogICAgICAgICAgICAgICAgICAgIGNvbG9yUGFsZXR0ZT17ZGF0YS5jb2xvclBhbGV0dGV9CiAgICAgICAgICAgICAgICAgICAgYXZhaWxhYmxlTGFiZWxzPXtkYXRhLmF2YWlsYWJsZUxhYmVsc30KICAgICAgICAgICAgICAgICAgICBhdmFpbGFibGVVc2Vycz17ZGF0YS5hdmFpbGFibGVVc2Vyc30KICAgICAgICAgICAgICAgICAgICByaWNoSW5wdXRIaWdobGlnaHQ9e2hhbmRsZUhpZ2hsaWdodH0KICAgICAgICAgICAgICAgICAgICByaWNoSW5wdXRUcmlnZ2VyPXtoYW5kbGVUcmlnZ2VyfQogICAgICAgICAgICAgICAgICAgIHJpY2hJbnB1dE9wdGlvbnM9e29wdGlvbnN9CiAgICAgICAgICAgICAgICAgICAgaXRlbT17eyAuLi50YXNrIH19CiAgICAgICAgICAgICAgICAgICAgb25DYW5jZWw9eygpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGFzayh7fSkKICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgIG9uU2F2ZT17KHRhc2spID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlVGFza1VwZGF0ZSh0YXNrKQogICAgICAgICAgICAgICAgICAgICAgICBzZXRUYXNrKHt9KQogICAgICAgICAgICAgICAgICAgIH19CiAgICAgICAgICAgICAgICAgICAgb25EZWxldGU9eyh0YXNrKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZVRhc2tEZWxldGUodGFzaykKICAgICAgICAgICAgICAgICAgICAgICAgc2V0VGFzayh7fSkKICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgKX0KCiAgICAgICAgICAgIDxNZW51UHJvdmlkZXIgbWVudT17Z2V0TWVudX0+CiAgICAgICAgICAgICAgICA8VG9kbwogICAgICAgICAgICAgICAgICAgIGlkPSJ0b2RvLWluc3RhbmNlLTEiCiAgICAgICAgICAgICAgICAgICAgc2VjdGlvbnM9e3NlY3Rpb25zfQogICAgICAgICAgICAgICAgICAgIG9uVGFza09wZW49e2hhbmRsZVRhc2tPcGVufQogICAgICAgICAgICAgICAgICAgIG9uVGFza1VwZGF0ZT17aGFuZGxlVGFza1VwZGF0ZX0KICAgICAgICAgICAgICAgICAgICBvblRhc2tBZGQ9e2hhbmRsZVRhc2tBZGR9CiAgICAgICAgICAgICAgICAgICAgb25UYXNrQWRkQmVsb3c9e2hhbmRsZVRhc2tBZGRCZWxvd30KICAgICAgICAgICAgICAgICAgICBvblRhc2tNb3ZlPXtoYW5kbGVUYXNrTW92ZX0KICAgICAgICAgICAgICAgICAgICBvblNlY3Rpb25VcGRhdGU9e2hhbmRsZVNlY3Rpb25VcGRhdGV9CiAgICAgICAgICAgICAgICAgICAgb25TZWN0aW9uQWRkPXtoYW5kbGVTZWN0aW9uQWRkfQogICAgICAgICAgICAgICAgICAgIG9uU2VjdGlvbk1vdmU9e2hhbmRsZVNlY3Rpb25Nb3ZlfQogICAgICAgICAgICAgICAgICAgIGF2YWlsYWJsZUxhYmVscz17ZGF0YS5hdmFpbGFibGVMYWJlbHN9CiAgICAgICAgICAgICAgICAgICAgb25MYWJlbEZpbHRlcj17KHZhbHVlKSA9PiBjb25zb2xlLmxvZygnZmlsdGVyIGxhYmVscycsIHZhbHVlKX0KICAgICAgICAgICAgICAgICAgICBhdmFpbGFibGVVc2Vycz17ZGF0YS5hdmFpbGFibGVVc2Vyc30KICAgICAgICAgICAgICAgICAgICBvblVzZXJGaWx0ZXI9eyh2YWx1ZSkgPT4gY29uc29sZS5sb2coJ2ZpbHRlciB1c2VycycsIHZhbHVlKX0KICAgICAgICAgICAgICAgICAgICByaWNoSW5wdXRIaWdobGlnaHQ9e2hhbmRsZUhpZ2hsaWdodH0KICAgICAgICAgICAgICAgICAgICByaWNoSW5wdXRUcmlnZ2VyPXtoYW5kbGVUcmlnZ2VyfQogICAgICAgICAgICAgICAgICAgIHJpY2hJbnB1dE9wdGlvbnM9e29wdGlvbnN9CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0VmFyaWFudD17eyAncHJvamVjdHMnOiAnZm9jdXMnIH19CiAgICAgICAgICAgICAgICAgICAgdGFzaz17dW5kZWZpbmVkfQogICAgICAgICAgICAgICAgICAgIHNlY3Rpb25IZWFkZXI9e3VuZGVmaW5lZH0KICAgICAgICAgICAgICAgICAgICBkZWZhdWx0U2VsZWN0aW9uPXt7fX0KICAgICAgICAgICAgICAgICAgICB0b29sYmFyPXsoeyBzZWxlY3Rpb24gfSkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgPFZpZXcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3cKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbj0iZml4ZWQiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYmdUb2tlbj0ic3VyZmFjZS1pbnZlcnNlIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbG9yVG9rZW49InRleHQtb24tY29sb3IiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcD0iMXJlbSAycmVtIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhZGl1cz0idmFyKC0tZi1yYWRpdXMpIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNoYWRvdz0idmFyKC0tZi1zaGFkb3cteGwpIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHpJbmRleD17MTAwMH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYXA9ezEwfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0iZi1mYWRlaW4iCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGxheT17IU9iamVjdC5rZXlzKHNlbGVjdGlvbikubGVuZ3RoID8gJ25vbmUnIDogJ2ZsZXgnfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0eWxlPXt7IGJvdHRvbTogMTAsIGxlZnQ6ICc1MCUnLCB0cmFuc2Zvcm06ICd0cmFuc2xhdGVYKC01MCUpJyB9fT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8VGV4dCBjb2xvcj0iaW5oZXJpdCI+e09iamVjdC5rZXlzKHNlbGVjdGlvbikubGVuZ3RofSBzZWxlY3RlZDwvVGV4dD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8SWNvbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uPXtGSUJpbn0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lPSJmLWJ1dHRvbml6ZSIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25DbGljaz17KCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0RGlhbG9nKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogJ0FyZSB5b3Ugc3VyZT8nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAnVGhpcyBhY3Rpb24gY2Fubm90IGJlIHVuZG9uZS4nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcnRhbDogUG9ydGFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvb3RlcjogKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8VmlldwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2lkdGg9IjEwMCUiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3cKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGp1c3RpZnlDb250ZW50PSJzcGFjZS1iZXR3ZWVuIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxCdXR0b24KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkNsaWNrPXsoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlRGlhbG9nKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGF0Y2hUb2RvRXZlbnQoJ3NlbGVjdCcsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWQ6ICd0b2RvLWluc3RhbmNlLTEnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH19PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENhbmNlbAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9CdXR0b24+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8QnV0dG9uCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyaWFudD0iZGFuZ2VyIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9kb1N0YXRlKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhc2ssCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRUYXNrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VjdGlvbnMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXRTZWN0aW9ucywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkuaGFuZGxlU2VsZWN0aW9uRGVsZXRlKHNlbGVjdGlvbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlzcGF0Y2hUb2RvRXZlbnQoJ3NlbGVjdCcsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc3RhbmNlSWQ6ICd0b2RvLWluc3RhbmNlLTEnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbG9zZURpYWxvZygpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfX0+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRGVsZXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L0J1dHRvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9WaWV3PgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L1ZpZXc+CiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICB9fQogICAgICAgICAgICAgICAgLz4KICAgICAgICAgICAgPC9NZW51UHJvdmlkZXI+CiAgICAgICAgPC8+CiAgICApCn0=" />

```tsx
export const Usage = () => {
    const [sections, setSections] = useState<any>(data.sections)
    const [task, setTask] = useState<any>({})
    const [options, setOptions] = useState<any>([])
    const { setDialog, closeDialog } = useDialog()

    const handleTaskOpen = (task) => {
        todoState({ task, setTask, sections, setSections }).handleTaskOpen(task)
    }

    const handleTaskUpdate = (taskData) => {
        todoState({ task, setTask, sections, setSections }).handleTaskUpdate(taskData)
    }

    const handleTaskDelete = (task) => {
        setDialog({
            title: 'Are you sure?',
            description: 'This action cannot be undone.',
            footer: (
                <View
                    row
                    width="100%"
                    justifyContent="space-between">
                    <Button onClick={closeDialog}>Cancel</Button>
                    <Button
                        onClick={() => {
                            todoState({ task, setTask, sections, setSections }).handleTaskDelete(task)
                            closeDialog()
                        }}
                        variant="danger">
                        Delete
                    </Button>
                </View>
            ),
        })
    }

    const handleTaskAddBelow = ({ id, shouldIndent, task: { title, users, badges, labels } }) => {
        todoState({ task, setTask, sections, setSections }).handleTaskAddBelow({
            id,
            shouldIndent,
            task: { title, users, badges, labels },
        })
    }

    const handleTaskAdd = ({ task, sectionIndex }) => {
        todoState({ task, setTask, sections, setSections }).handleTaskAdd({ task, sectionIndex })
    }

    const handleTaskMove = ({ origin, target, selection }) => {
        todoState({ task, setTask, sections, setSections }).handleTaskMove({ origin, target, selection })
    }

    const handleSectionUpdate = (sec) => {
        todoState({ task, setTask, sections, setSections }).handleSectionUpdate(sec)
    }

    const handleSectionDelete = (sec) => {
        todoState({ task, setTask, sections, setSections }).handleSectionDelete(sec)
    }

    const handleSectionAdd = ({ name, sectionIndex }) => {
        todoState({ task, setTask, sections, setSections }).handleSectionAdd({ name, sectionIndex })
    }

    const handleSectionMove = ({ origin, target }) => {
        todoState({ task, setTask, sections, setSections }).handleSectionMove({ origin, target })
    }

    const handleTrigger = (word) => {
        if (word.trim().charAt(0) == '@') {
            setOptions(data.richInputUsers)
        } else if (word.trim().charAt(0) == '#') {
            setOptions(data.richInputLabels)
        } else {
            setOptions([])
        }
    }

    const handleHighlight = (word, cb, always = false) => {
        if (word.includes('date:')) {
            cb({
                phrase: word.trim(),
                type: 'date',
                value: word.split(':')[1].trim(),
            })
        } else {
            if (always) cb(null)
        }
    }

    const getMenu = ({ data: { target, payload }, dismiss }) => {
        switch (target) {
            case 'todo-label':
                return (
                    <LabelMenu
                        onFilter={(value) => console.log('filter', value)}
                        availableLabels={data.availableLabels}
                        labels={payload.labels}
                        onCancel={dismiss}
                        onSave={(labels) => {
                            handleTaskUpdate({ ...payload, labels })
                            dismiss()
                        }}
                    />
                )
            case 'todo-user':
                return (
                    <UserMenu
                        onFilter={(value) => console.log('filter', value)}
                        availableUsers={data.availableUsers}
                        users={payload.users}
                        onCancel={dismiss}
                        onSave={(users) => {
                            handleTaskUpdate({ ...payload, users })
                            dismiss()
                        }}
                    />
                )
            case 'todo-menu':
                return (
                    <Popup
                        isTodo
                        item={payload}
                        onCancel={dismiss}
                        colorPalette={data.colorPalette}
                        onTodoAddBelow={() => {
                            dismiss()
                            dispatchTodoEvent('add-task-below', { id: payload.id })
                        }}
                        onTodoEdit={() => {
                            dismiss()
                            dispatchTodoEvent('edit-task', { id: payload.id })
                        }}
                        onSave={(card) => {
                            dismiss()
                            handleTaskUpdate({ ...payload, ...card })
                        }}
                        onView={() => {
                            dismiss()
                            setTask(payload)
                        }}
                        onDelete={() => {
                            dismiss()
                            handleTaskDelete(payload)
                        }}
                    />
                )
            case 'todo-section':
                return (
                    <TodoSectionMenu
                        colorPalette={data.colorPalette}
                        onSave={(section) => {
                            handleSectionUpdate({ ...payload, ...section })
                            dismiss()
                        }}
                        onDelete={() => {
                            handleSectionDelete(payload)
                            dismiss()
                        }}
                        section={payload}
                    />
                )
            default:
                return null
        }
    }

    return (
        <>
            {!!task.id && (
                <Detail
                    useRichTitle
                    colorPalette={data.colorPalette}
                    availableLabels={data.availableLabels}
                    availableUsers={data.availableUsers}
                    richInputHighlight={handleHighlight}
                    richInputTrigger={handleTrigger}
                    richInputOptions={options}
                    item={{ ...task }}
                    onCancel={() => {
                        setTask({})
                    }}
                    onSave={(task) => {
                        handleTaskUpdate(task)
                        setTask({})
                    }}
                    onDelete={(task) => {
                        handleTaskDelete(task)
                        setTask({})
                    }}
                />
            )}

            <MenuProvider menu={getMenu}>
                <Todo
                    id="todo-instance-1"
                    sections={sections}
                    onTaskOpen={handleTaskOpen}
                    onTaskUpdate={handleTaskUpdate}
                    onTaskAdd={handleTaskAdd}
                    onTaskAddBelow={handleTaskAddBelow}
                    onTaskMove={handleTaskMove}
                    onSectionUpdate={handleSectionUpdate}
                    onSectionAdd={handleSectionAdd}
                    onSectionMove={handleSectionMove}
                    availableLabels={data.availableLabels}
                    onLabelFilter={(value) => console.log('filter labels', value)}
                    availableUsers={data.availableUsers}
                    onUserFilter={(value) => console.log('filter users', value)}
                    richInputHighlight={handleHighlight}
                    richInputTrigger={handleTrigger}
                    richInputOptions={options}
                    targetVariant={{ 'projects': 'focus' }}
                    task={undefined}
                    sectionHeader={undefined}
                    defaultSelection={{}}
                    toolbar={({ selection }) => {
                        return (
                            <View
                                row
                                position="fixed"
                                bgToken="surface-inverse"
                                colorToken="text-on-color"
                                p="1rem 2rem"
                                radius="var(--f-radius)"
                                shadow="var(--f-shadow-xl)"
                                zIndex={1000}
                                gap={10}
                                className="f-fadein"
                                display={!Object.keys(selection).length ? 'none' : 'flex'}
                                style={{ bottom: 10, left: '50%', transform: 'translateX(-50%)' }}>
                                <Text color="inherit">{Object.keys(selection).length} selected</Text>
                                <Icon
                                    icon={FIBin}
                                    className="f-buttonize"
                                    onClick={() => {
                                        setDialog({
                                            title: 'Are you sure?',
                                            description: 'This action cannot be undone.',
                                            portal: Portal,
                                            footer: (
                                                <View
                                                    width="100%"
                                                    row
                                                    justifyContent="space-between">
                                                    <Button
                                                        onClick={() => {
                                                            closeDialog()
                                                            dispatchTodoEvent('select', {
                                                                instanceId: 'todo-instance-1',
                                                            })
                                                        }}>
                                                        Cancel
                                                    </Button>
                                                    <Button
                                                        variant="danger"
                                                        onClick={() => {
                                                            todoState({
                                                                task,
                                                                setTask,
                                                                sections,
                                                                setSections,
                                                            }).handleSelectionDelete(selection)
                                                            dispatchTodoEvent('select', {
                                                                instanceId: 'todo-instance-1',
                                                            })
                                                            closeDialog()
                                                        }}>
                                                        Delete
                                                    </Button>
                                                </View>
                                            ),
                                        })
                                    }}
                                />
                            </View>
                        )
                    }}
                />
            </MenuProvider>
        </>
    )
}
```

export default ({ children }) => <ComponentLayout docs={docs} props={props} css={css}>{children}</ComponentLayout>
